<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WhereDoILive ‚Äì Karte mit Standort</title>

  <!-- Leaflet CSS (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root { --bg:#111827; --fg:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; }
    body { margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    header { padding:16px 20px; border-bottom:1px solid #1f2937; }
    h1 { margin:0 0 4px; font-size:20px; }
    small { color:var(--muted); }
    .toolbar { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    button {
      background:var(--accent); color:#0b1020; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    button.secondary { background:#374151; color:var(--fg); }
    #app { display:grid; grid-template-columns: 340px 1fr; gap:0; min-height: calc(100vh - 70px); }
    #left { padding:14px 16px; border-right:1px solid #1f2937; }
    #status { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0b1020; color:#c7d2fe; border:1px solid #1f2937; border-radius:10px; padding:10px; min-height:130px; }
    #map { width:100%; height: calc(100vh - 70px); }
    .kv { margin:10px 0 14px; }
    .kv b { display:inline-block; min-width:140px; color:#cbd5e1; }
    .hint { color:var(--muted); font-size:14px; margin-top:10px; }
    a { color:#93c5fd; }
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; }
      #map { height: 56vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Smart &amp; Safe ‚Äì Wo bin ich?</h1>
    <small>Demonstration: Browser-Standort, Genauigkeit, IP-Ortung und Karte</small>
    <div class="toolbar">
      <button id="btnGeo">üìç Standort per Browser ermitteln</button>
      <button id="btnIP" class="secondary">üåê Grobe Ortung per IP (Fallback)</button>
      <button id="btnReset" class="secondary">‚ôªÔ∏è Karte zur√ºcksetzen</button>
    </div>
  </header>

  <div id="app">
    <section id="left">
      <div class="kv"><b>Status:</b> <span id="statusLine">bereit</span></div>
      <div class="kv"><b>Koordinaten:</b> <span id="coords">‚Äì</span></div>
      <div class="kv"><b>Genauigkeit:</b> <span id="accuracy">‚Äì</span></div>
      <div class="kv"><b>Quelle:</b> <span id="source">‚Äì</span></div>
      <div id="status"></div>
      <p class="hint">
        Hinweis: Die **Browser-Geolocation** fragt dich nach Erlaubnis und ist meist genauer (WLAN/GPS).  
        Die **IP-Ortung** ist nur ungef√§hr (Stadt/Region) und kann danebenliegen.  
        Kartenkacheln kommen von <a href="https://www.openstreetmap.org" target="_blank" rel="noreferrer">OpenStreetMap</a>.
      </p>
    </section>
    <section id="map"></section>
  </div>

  <!-- Leaflet JS (CDN) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // --- Karte vorbereiten ---
    const map = L.map('map', { zoomControl: true });
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap-Mitwirkende'
    }).addTo(map);

    // Startansicht: Deutschland (ungef√§hr)
    map.setView([51.163, 10.447], 6);

    let marker = null;
    let accuracyCircle = null;

    // UI-Helper
    const sLine = document.getElementById('statusLine');
    const sBox  = document.getElementById('status');
    const sCoords = document.getElementById('coords');
    const sAcc = document.getElementById('accuracy');
    const sSrc = document.getElementById('source');

    function log(msg) {
      sBox.textContent = (sBox.textContent ? sBox.textContent + '\n' : '') + msg;
    }
    function setStatus(line) { sLine.textContent = line; }
    function setInfo(lat, lon, acc, src) {
      sCoords.textContent = lat && lon ? `${lat.toFixed(6)}, ${lon.toFixed(6)}` : '‚Äì';
      sAcc.textContent = (typeof acc === 'number') ? `${Math.round(acc)} m` : '‚Äì';
      sSrc.textContent = src || '‚Äì';
    }
    function clearMap() {
      if (marker) { map.removeLayer(marker); marker = null; }
      if (accuracyCircle) { map.removeLayer(accuracyCircle); accuracyCircle = null; }
      setInfo(null,null,null,null);
      setStatus('bereit');
    }
    function showOnMap(lat, lon, accuracyMeters, label) {
      if (marker) map.removeLayer(marker);
      if (accuracyCircle) map.removeLayer(accuracyCircle);

      marker = L.marker([lat, lon]).addTo(map);
      marker.bindPopup(label || 'Standort').openPopup();

      if (typeof accuracyMeters === 'number' && isFinite(accuracyMeters) && accuracyMeters > 0) {
        accuracyCircle = L.circle([lat, lon], { radius: accuracyMeters }).addTo(map);
      }
      map.setView([lat, lon], accuracyMeters && accuracyMeters < 500 ? 16 : 14);
      setInfo(lat, lon, accuracyMeters, label);
    }

    // --- Geolocation (Browser) ---
    async function locateViaBrowser() {
      sBox.textContent = '';
      setStatus('Frage Browser-Geolocation an ‚Ä¶');
      log('Versuche Geolocation (hohe Genauigkeit, Timeout 7 s)‚Ä¶');

      if (!('geolocation' in navigator)) {
        setStatus('Geolocation wird von diesem Browser nicht unterst√ºtzt.');
        log('Fehler: navigator.geolocation nicht verf√ºgbar.');
        return;
      }
      const options = {
        enableHighAccuracy: true,
        timeout: 7000,
        maximumAge: 0
      };
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          setStatus('Standort bestimmt (Browser).');
          log(`Erfolg: lat=${latitude}, lon=${longitude}, accuracy‚âà${Math.round(accuracy)} m`);
          showOnMap(latitude, longitude, accuracy, 'Browser-Geolocation');
        },
        (err) => {
          // Fehlercodes: 1=PERMISSION_DENIED, 2=POSITION_UNAVAILABLE, 3=TIMEOUT
          setStatus(`Geolocation fehlgeschlagen (Code ${err.code}).`);
          log(`Fehler (${err.code}): ${err.message}`);
          if (err.code === 1) log('Tipp: Erlaubnis erteilen oder im Browser/OS aktivieren.');
          if (err.code === 2) log('Tipp: WLAN/GPS pr√ºfen. Manchmal hilft ein zweiter Versuch.');
          if (err.code === 3) log('Tipp: Timeout ‚Äì noch einmal versuchen oder IP-Fallback nutzen.');
        },
        options
      );
    }

    // --- IP-Fallback (sehr grob) ---
    async function locateViaIP() {
      sBox.textContent = '';
      setStatus('Ermittle grobe Position √ºber IP ‚Ä¶');
      log('Sende Anfrage an √∂ffentlichen IP-Geolokationsdienst‚Ä¶');

      try {
        // √ñffentlicher Demo-Dienst (kann in manchen Netzen blockiert sein)
        const resp = await fetch('https://ipapi.co/json/');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        const lat = Number(data.latitude);
        const lon = Number(data.longitude);
        if (isFinite(lat) && isFinite(lon)) {
          setStatus('Grobe Position bestimmt (IP).');
          log(`Erfolg: Stadt=${data.city}, Region=${data.region}, Land=${data.country_name}`);
          showOnMap(lat, lon, null, 'IP-Ortung (grobe Sch√§tzung)');
        } else {
          throw new Error('Antwort ohne Koordinaten');
        }
      } catch (e) {
        setStatus('IP-Ortung fehlgeschlagen.');
        log('Fehler bei IP-Ortung: ' + e.message);
        log('Tipp: Schulnetz/Firewall kann externe Anfragen blockieren.');
      }
    }

    // Buttons
    document.getElementById('btnGeo').addEventListener('click', locateViaBrowser);
    document.getElementById('btnIP').addEventListener('click', locateViaIP);
    document.getElementById('btnReset').addEventListener('click', clearMap);

    // Optional: Beim Laden direkt versuchen (kannst du auslassen)
    // locateViaBrowser();
  </script>
</body>
</html>
